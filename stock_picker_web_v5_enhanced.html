<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šå¸‚å ´æ™ºèƒ½é¸è‚¡ç³»çµ± v4.0 Enhanced</title>
    <style>
        /* ==================== å…¨å±€æ¨£å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* ä¸»è‰²èª¿ */
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            
            /* æ¬¡è¦è‰²èª¿ */
            --secondary-color: #8b5cf6;
            --accent-color: #ec4899;
            
            /* èƒŒæ™¯è‰² */
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ec4899 100%);
            --card-bg: #ffffff;
            --hover-bg: #f9fafb;
            
            /* æ–‡å­—è‰² */
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            
            /* é‚Šæ¡†å’Œé™°å½± */
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
            
            /* ç‹€æ…‹è‰² */
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
            
            /* é–“è· */
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            
            /* åœ“è§’ */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            /* éæ¸¡æ•ˆæœ */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', 'Noto Sans TC', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: var(--spacing-lg);
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        /* ==================== å®¹å™¨ä½ˆå±€ ==================== */
        .main-container {
            max-width: 1800px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            animation: fadeInUp var(--transition-slow);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ==================== é é¦– ==================== */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: var(--spacing-xl) var(--spacing-lg);
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }
        
        /* ==================== ä¸»å…§å®¹å€ ==================== */
        .content {
            padding: var(--spacing-xl);
        }
        
        /* ==================== æ¨™ç±¤é  ==================== */
        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab {
            padding: var(--spacing-md) var(--spacing-lg);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
        }
        
        .tab:hover {
            color: var(--primary-color);
            background: var(--hover-bg);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn var(--transition-base);
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* ==================== å¡ç‰‡ ==================== */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: box-shadow var(--transition-base);
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        /* ==================== è¡¨å–®å…ƒç´  ==================== */
        .form-group {
            margin-bottom: var(--spacing-md);
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            font-size: 0.95rem;
        }
        
        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            transition: all var(--transition-fast);
            background: white;
        }
        
        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-input:hover,
        .form-select:hover {
            border-color: var(--primary-light);
        }
        
        /* ==================== æŒ‰éˆ• ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--hover-bg);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--border-color);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ==================== è¡¨æ ¼æ¨£å¼ ==================== */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            margin-top: var(--spacing-md);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .table thead {
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            border-bottom: 2px solid var(--border-color);
        }
        
        .table th {
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            color: var(--text-primary);
            position: relative;
            z-index: 10;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        
        /* æ’åºç®­é ­æ¨£å¼ */
        .table th.sortable::after {
            content: 'â‡…';
            margin-left: 0.5rem;
            opacity: 0.3;
            font-size: 0.8rem;
        }
        
        .table th.sortable:hover::after {
            opacity: 0.7;
        }
        
        .table th.sort-asc::after {
            content: 'â–²';
            opacity: 1;
            color: var(--primary-color);
        }
        
        .table th.sort-desc::after {
            content: 'â–¼';
            opacity: 1;
            color: var(--primary-color);
        }
        
        .table td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        
        .table tbody tr {
            transition: background-color var(--transition-fast);
        }
        
        .table tbody tr:hover {
            background-color: var(--hover-bg);
        }
        
        /* ==================== å¾½ç«  ==================== */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }
        
        .badge-market {
            background: linear-gradient(135deg, var(--info-color), #2563eb);
            color: white;
        }
        
        .badge-buy {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }
        
        .badge-sell {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
        }
        
        .badge-hold {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }
        
        /* ==================== è¨Šæ¯ ==================== */
        .message {
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
            animation: slideIn var(--transition-base);
            position: relative;
            z-index: 1;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .message-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-success {
            background: #d1fae5;
            border-left: 4px solid var(--success-color);
            color: #065f46;
        }
        
        .message-error {
            background: #fee2e2;
            border-left: 4px solid var(--error-color);
            color: #991b1b;
        }
        
        .message-info {
            background: #dbeafe;
            border-left: 4px solid var(--info-color);
            color: #1e40af;
        }
        
        .message-warning {
            background: #fef3c7;
            border-left: 4px solid var(--warning-color);
            color: #92400e;
        }
        
        /* ==================== åŠ è¼‰å‹•ç•« ==================== */
        .loading {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 3px solid rgba(99, 102, 241, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            padding: var(--spacing-xl);
        }
        
        .loading-text {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* ==================== é€²åº¦æ¢ ==================== */
        .progress-container {
            margin-top: var(--spacing-md);
        }
        
        .progress-bar {
            width: 100%;
            height: 2rem;
            background: #f3f4f6;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* ==================== è©³ç´°åˆ†æå¡ç‰‡ ==================== */
        .analysis-detail {
            background: linear-gradient(135deg, #fafafa, #ffffff);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-md);
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }
        
        .metric-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
            transition: all var(--transition-base);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }
        
        .metric-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        /* ==================== ä¿¡æ¯åœ–æ¨™æç¤º ==================== */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--info-color);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
        }
        
        .info-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: normal;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }
        
        .info-icon:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }
        
        /* ==================== ç¯©é¸æ¢ä»¶å¢å¼·æ¨£å¼ ==================== */
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .filter-group {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            min-width: 0; /* é˜²æ­¢å…§å®¹æº¢å‡º */
        }

        .filter-group-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-xs);
            border-bottom: 2px solid var(--border-color);
        }

        .filter-item {
            margin-bottom: var(--spacing-md);
        }

        .filter-item:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            font-size: 0.9rem;
        }

        .filter-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .filter-label-text {
            flex: 1;
        }

        .input-with-buttons {
            display: flex;
            gap: 2px; /* å¾ 4px æ¸›å°åˆ° 2pxï¼Œè®“æŒ‰éˆ•å’Œè¼¸å…¥æ¡†æ›´ç·Šå¯† */
            align-items: stretch;
        }

        .input-with-buttons input {
            flex: 1;
            min-width: 0; /* å…è¨±è¼¸å…¥æ¡†ç¸®å° */
            max-width: 100%; /* é˜²æ­¢æº¢å‡º */
            padding: 0.4rem 0.4rem; /* é€²ä¸€æ­¥æ¸›å°å·¦å³padding */
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.8rem; /* å¾ 0.85rem é€²ä¸€æ­¥ç¸®å° */
            transition: all var(--transition-fast);
            width: 100%; /* ç¢ºä¿å¯¬åº¦å—é™ */
        }

        .input-with-buttons input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .input-with-buttons input:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .adjust-btn {
            width: 28px; /* å¾ 30px é€²ä¸€æ­¥ç¸®å° */
            height: 28px;
            flex-shrink: 0;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: var(--radius-md);
            font-size: 0.9rem; /* å¾ 1rem ç¸®å° */
            font-weight: 700;
            color: var(--primary-color);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .adjust-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .adjust-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .adjust-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .range-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2px; /* å¾ 4px æ¸›å°åˆ° 2px */
            align-items: stretch;
        }

        .range-separator {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.75rem; /* å¾ 0.85rem é€²ä¸€æ­¥ç¸®å° */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 2px; /* å¾ 4px æ¸›å°åˆ° 2px */
            white-space: nowrap;
        }

        .reset-filters-btn {
            background: var(--hover-bg);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .reset-filters-btn:hover {
            background: var(--border-color);
        }

        /* éŸ¿æ‡‰å¼å„ªåŒ– */
        @media (max-width: 1200px) {
            .filter-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }

            .range-inputs {
                grid-template-columns: 1fr;
                gap: var(--spacing-xs);
            }

            .range-separator {
                display: none;
            }
        }

        /* ==================== éŸ¿æ‡‰å¼è¨­è¨ˆ ==================== */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-sm);
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .header p {
                font-size: 0.95rem;
            }
            
            .content {
                padding: var(--spacing-md);
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 0.9rem;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- é é¦– -->
        <div class="header">
            <h1>ğŸš€ å¤šå¸‚å ´æ™ºèƒ½é¸è‚¡ç³»çµ± v4.0</h1>
            <p>æ”¯æ´ç¾è‚¡ + å°è‚¡ | æ™ºèƒ½åˆ†æ | å³æ™‚é æ¸¬ | Enhanced Edition</p>
        </div>
        
        <!-- ä¸»å…§å®¹ -->
        <div class="content">
            <!-- æ¨™ç±¤é å°èˆª -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('download')">
                    ğŸ“¥ ä¸‹è¼‰æ•¸æ“š
                </button>
                <button class="tab" onclick="switchTab('analyze')">
                    ğŸ“Š å–®è‚¡åˆ†æ
                </button>
                <button class="tab" onclick="switchTab('screen')">
                    ğŸ” æ™ºèƒ½ç¯©é¸
                </button>
                <button class="tab" onclick="switchTab('local')">
                    ğŸ’¾ æœ¬åœ°è‚¡ç¥¨
                </button>
            </div>
            
            <!-- æ¨™ç±¤é å…§å®¹ -->
            
            <!-- 1. ä¸‹è¼‰æ•¸æ“š -->
            <div id="download" class="tab-content active">
                <div class="card">
                    <h2 class="card-title">ğŸ“¥ ä¸‹è¼‰è‚¡ç¥¨æ•¸æ“š</h2>
                    
                    <div class="form-group">
                        <label class="form-label">å¸‚å ´é¸æ“‡</label>
                        <select id="download-market" class="form-select">
                            <option value="auto">è‡ªå‹•åµæ¸¬</option>
                            <option value="US">ğŸ‡ºğŸ‡¸ ç¾è‚¡</option>
                            <option value="TW">ğŸ‡¹ğŸ‡¼ å°è‚¡</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¯ç”¨é€—è™Ÿåˆ†éš”å¤šæ”¯ï¼‰</label>
                        <input type="text" id="download-symbols" class="form-input" 
                               placeholder="ä¾‹å¦‚: AAPL,MSFT æˆ– 2330,2317">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é è¨­æ¸…å–®ï¼ˆå¯é¸ï¼‰</label>
                        <select id="download-preset" class="form-select" onchange="loadPresetSymbols()">
                            <option value="">-- é¸æ“‡é è¨­æ¸…å–® --</option>
                            <optgroup label="ğŸ‡ºğŸ‡¸ ç¾è‚¡">
                                <option value="us-dow">é“ç“Šæ–¯ 30</option>
                                <option value="us-sp500">S&P 500</option>
                                <option value="us-nasdaq100">NASDAQ 100</option>
                                <option value="us-popular">ç†±é–€ç¾è‚¡</option>
                            </optgroup>
                            <optgroup label="ğŸ‡¹ğŸ‡¼ å°è‚¡">
                                <option value="tw-tw50">å°ç£50</option>
                                <option value="tw-semiconductor">åŠå°é«”</option>
                                <option value="tw-finance">é‡‘èè‚¡</option>
                                <option value="tw-all">å…¨éƒ¨å°è‚¡(227æ”¯)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ•¸æ“šæœŸé–“</label>
                        <select id="download-period" class="form-select">
                            <option value="1y">1å¹´</option>
                            <option value="2y" selected>2å¹´</option>
                            <option value="5y">5å¹´</option>
                            <option value="max">æœ€å¤§</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="downloadData()">
                        é–‹å§‹ä¸‹è¼‰
                    </button>
                    
                    <div id="download-result" style="margin-top: var(--spacing-lg);"></div>
                </div>
            </div>
            
            <!-- 2. å–®è‚¡åˆ†æ -->
            <div id="analyze" class="tab-content">
                <div class="card">
                    <h2 class="card-title">ğŸ“Š å–®è‚¡æ·±åº¦åˆ†æ</h2>
                    
                    <div class="form-group">
                        <label class="form-label">è‚¡ç¥¨ä»£ç¢¼</label>
                        <input type="text" id="analyze-symbol" class="form-input" 
                               placeholder="ä¾‹å¦‚: AAPL æˆ– 2330">
                    </div>
                    
                    <button class="btn btn-primary" onclick="analyzeStock()">
                        åŸ·è¡Œåˆ†æ
                    </button>
                    
                    <div id="analyze-result" style="margin-top: var(--spacing-lg);"></div>
                </div>
            </div>
            
            <!-- 3. æ™ºèƒ½ç¯©é¸ -->
            <div id="screen" class="tab-content">
                <div class="card">
                    <h2 class="card-title">ğŸ” æ™ºèƒ½è‚¡ç¥¨ç¯©é¸</h2>
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                        è¨­å®šç¯©é¸æ¢ä»¶ä»¥æ‰¾åˆ°ç¬¦åˆæ‚¨æŠ•è³‡ç­–ç•¥çš„è‚¡ç¥¨ã€‚ä½¿ç”¨ +/- æŒ‰éˆ•å¿«é€Ÿèª¿æ•´ï¼Œæˆ–ç›´æ¥è¼¸å…¥æ•¸å€¼ã€‚
                    </p>

                    <!-- ç¯©é¸æ¢ä»¶ç¶²æ ¼ -->
                    <div class="filter-grid">
                        <!-- åŸºæœ¬ç¯©é¸ -->
                        <div class="filter-group">
                            <div class="filter-group-title">ğŸ“Š åŸºæœ¬ç¯©é¸</div>

                            <div class="filter-item">
                                <label class="filter-label">
                                    <input type="checkbox" class="filter-checkbox" id="enable-market" checked onchange="toggleFilter('screen-market', this.checked)">
                                    <span class="filter-label-text">å¸‚å ´</span>
                                </label>
                                <select id="screen-market" class="form-select">
                                    <option value="all">å…¨éƒ¨å¸‚å ´</option>
                                    <option value="US">ğŸ‡ºğŸ‡¸ åƒ…ç¾è‚¡</option>
                                    <option value="TW">ğŸ‡¹ğŸ‡¼ åƒ…å°è‚¡</option>
                                </select>
                            </div>

                            <div class="filter-item">
                                <label class="filter-label">
                                    <input type="checkbox" class="filter-checkbox" id="enable-score">
                                    <span class="filter-label-text">è©•åˆ†ç¯„åœ (0-100)</span>
                                </label>
                                <div class="range-inputs">
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-score', -5)" data-target="screen-min-score">âˆ’</button>
                                        <input type="number" id="screen-min-score" value="0" min="0" max="100" step="5" disabled>
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-score', 5)" data-target="screen-min-score">+</button>
                                    </div>
                                    <span class="range-separator">è‡³</span>
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-score', -5)" data-target="screen-max-score">âˆ’</button>
                                        <input type="number" id="screen-max-score" value="100" min="0" max="100" step="5" disabled>
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-score', 5)" data-target="screen-max-score">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-item">
                                <label class="filter-label">
                                    <input type="checkbox" class="filter-checkbox" id="enable-action">
                                    <span class="filter-label-text">æ“ä½œå»ºè­°</span>
                                </label>
                                <select id="screen-action" class="form-select" disabled>
                                    <option value="all">å…¨éƒ¨</option>
                                    <option value="BUY">åƒ…è²·å…¥ (BUY)</option>
                                    <option value="HOLD">åƒ…æŒæœ‰ (HOLD)</option>
                                    <option value="SELL">åƒ…è³£å‡º (SELL)</option>
                                </select>
                            </div>
                        </div>

                        <!-- åƒ¹æ ¼èˆ‡å ±é…¬ -->
                        <div class="filter-group">
                            <div class="filter-group-title">ğŸ’° åƒ¹æ ¼èˆ‡å ±é…¬</div>

                            <div class="filter-item">
                                <label class="filter-label">ç¾åƒ¹ç¯„åœ</label>
                                <div class="range-inputs">
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-price', -10)" data-target="screen-min-price">âˆ’</button>
                                        <input type="number" id="screen-min-price" value="0" min="0" step="10">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-price', 10)" data-target="screen-min-price">+</button>
                                    </div>
                                    <span class="range-separator">~</span>
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-price', -10)" data-target="screen-max-price">âˆ’</button>
                                        <input type="number" id="screen-max-price" value="9999" min="0" step="10">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-price', 10)" data-target="screen-max-price">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-item">
                                <label class="filter-label">é æœŸå ±é…¬ç‡ (%)</label>
                                <div class="range-inputs">
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-return', -5)" data-target="screen-min-return">âˆ’</button>
                                        <input type="number" id="screen-min-return" value="-100" min="-100" max="100" step="5">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-return', 5)" data-target="screen-min-return">+</button>
                                    </div>
                                    <span class="range-separator">~</span>
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-return', -5)" data-target="screen-max-return">âˆ’</button>
                                        <input type="number" id="screen-max-return" value="100" min="-100" max="100" step="5">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-return', 5)" data-target="screen-max-return">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-item">
                                <label class="filter-label">ç›®æ¨™åƒ¹ç¯„åœ</label>
                                <div class="range-inputs">
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-target', -10)" data-target="screen-min-target">âˆ’</button>
                                        <input type="number" id="screen-min-target" value="0" min="0" step="10">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-target', 10)" data-target="screen-min-target">+</button>
                                    </div>
                                    <span class="range-separator">~</span>
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-target', -10)" data-target="screen-max-target">âˆ’</button>
                                        <input type="number" id="screen-max-target" value="9999" min="0" step="10">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-target', 10)" data-target="screen-max-target">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- é¢¨éšªèˆ‡æµå‹•æ€§ -->
                        <div class="filter-group">
                            <div class="filter-group-title">âš–ï¸ é¢¨éšªèˆ‡æµå‹•æ€§</div>

                            <div class="filter-item">
                                <label class="filter-label">é¢¨éšªå ±é…¬æ¯”</label>
                                <div class="range-inputs">
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-rr', -0.5)">âˆ’</button>
                                        <input type="number" id="screen-min-rr" value="0" min="0" max="10" step="0.5" placeholder="æœ€ä½">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-rr', 0.5)">+</button>
                                    </div>
                                    <span class="range-separator">è‡³</span>
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-rr', -0.5)">âˆ’</button>
                                        <input type="number" id="screen-max-rr" value="10" min="0" max="10" step="0.5" placeholder="æœ€é«˜">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-rr', 0.5)">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-item">
                                <label class="filter-label">ç›¸å°æˆäº¤é‡</label>
                                <div class="range-inputs">
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-rel-vol', -0.5)">âˆ’</button>
                                        <input type="number" id="screen-min-rel-vol" value="0" min="0" max="10" step="0.5" placeholder="æœ€ä½">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-rel-vol', 0.5)">+</button>
                                    </div>
                                    <span class="range-separator">è‡³</span>
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-rel-vol', -0.5)">âˆ’</button>
                                        <input type="number" id="screen-max-rel-vol" value="10" min="0" max="10" step="0.5" placeholder="æœ€é«˜">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-rel-vol', 0.5)">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-item">
                                <label class="filter-label">æµå‹•æ€§è©•ç´š</label>
                                <select id="screen-liquidity" class="form-select">
                                    <option value="all">å…¨éƒ¨</option>
                                    <option value="æ¥µé«˜">æ¥µé«˜</option>
                                    <option value="é«˜">é«˜</option>
                                    <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                                    <option value="ä½">ä½</option>
                                    <option value="æ¥µä½">æ¥µä½</option>
                                </select>
                            </div>
                        </div>

                        <!-- æ™‚é–“èˆ‡å…¶ä»– -->
                        <div class="filter-group">
                            <div class="filter-group-title">â° æ™‚é–“èˆ‡å…¶ä»–</div>

                            <div class="filter-item">
                                <label class="filter-label">é”æˆæ™‚é–“ (å¤©)</label>
                                <div class="range-inputs">
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-days', -10)">âˆ’</button>
                                        <input type="number" id="screen-min-days" value="0" min="0" max="365" step="10" placeholder="æœ€å°‘">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-days', 10)">+</button>
                                    </div>
                                    <span class="range-separator">è‡³</span>
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-days', -10)">âˆ’</button>
                                        <input type="number" id="screen-max-days" value="365" min="0" max="365" step="10" placeholder="æœ€å¤š">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-days', 10)">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-item">
                                <label class="filter-label">å¹³å‡æˆäº¤é‡ (è¬)</label>
                                <div class="range-inputs">
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-avg-vol', -10000)" data-target="screen-min-avg-vol">âˆ’</button>
                                        <input type="number" id="screen-min-avg-vol" value="0" min="0" step="10000">
                                        <button class="adjust-btn" onclick="adjustValue('screen-min-avg-vol', 10000)" data-target="screen-min-avg-vol">+</button>
                                    </div>
                                    <span class="range-separator">~</span>
                                    <div class="input-with-buttons">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-avg-vol', -10000)" data-target="screen-max-avg-vol">âˆ’</button>
                                        <input type="number" id="screen-max-avg-vol" value="999999999" min="0" step="10000">
                                        <button class="adjust-btn" onclick="adjustValue('screen-max-avg-vol', 10000)" data-target="screen-max-avg-vol">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                        <button class="btn btn-primary" onclick="screenStocks()" style="flex: 1;">
                            ğŸ” é–‹å§‹ç¯©é¸
                        </button>
                        <button class="reset-filters-btn" onclick="resetFilters()">
                            ğŸ”„ é‡ç½®æ¢ä»¶
                        </button>
                    </div>

                    <div id="screen-result" style="margin-top: var(--spacing-lg);"></div>
                </div>
            </div>
            
            <!-- 4. æœ¬åœ°è‚¡ç¥¨ -->
            <div id="local" class="tab-content">
                <div class="card">
                    <h2 class="card-title">ğŸ’¾ æœ¬åœ°è‚¡ç¥¨æ•¸æ“š</h2>
                    
                    <button class="btn btn-primary" onclick="loadLocalStocks()">
                        åˆ·æ–°åˆ—è¡¨
                    </button>
                    
                    <div id="local-result" style="margin-top: var(--spacing-lg);"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== å…¨å±€è®Šæ•¸ ====================
        const API_BASE = 'http://localhost:5000/api';
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        let screenResultsData = [];
        
        // ==================== æ¨™ç±¤é åˆ‡æ› ====================
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤é å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„activeç‹€æ…‹
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤é 
            document.getElementById(tabName).classList.add('active');
            
            // é«˜äº®é¸ä¸­çš„æ¨™ç±¤
            event.target.classList.add('active');
        }
        
        // ==================== é è¨­è‚¡ç¥¨æ¸…å–® ====================
        const presetSymbols = {
            'us-dow': 'AAPL,AMGN,AXP,BA,CAT,CRM,CSCO,CVX,DIS,DOW,GS,HD,HON,IBM,INTC,JNJ,JPM,KO,MCD,MMM,MRK,MSFT,NKE,PG,TRV,UNH,V,VZ,WBA,WMT',
            'us-sp500': 'AAPL,MSFT,GOOGL,AMZN,NVDA,META,TSLA,BRK-B,UNH,JNJ,JPM,V,XOM,WMT,PG,MA,HD,CVX,ABBV,LLY',
            'us-nasdaq100': 'AAPL,MSFT,GOOGL,AMZN,NVDA,META,TSLA,AVGO,COST,ADBE,NFLX,AMD,INTC,QCOM,TXN',
            'us-popular': 'AAPL,MSFT,GOOGL,AMZN,NVDA,META,TSLA,BRK-B,UNH,JNJ',
            'tw-tw50': '2330,2317,2454,2881,2882,2891,2886,2412,2308,2303',
            'tw-semiconductor': '2330,2454,2303,3034,2408,3711,2379,3443,6505,5269',
            'tw-finance': '2881,2882,2891,2886,2884,2885,2887,2890,2892,5880',
            'tw-all': 'all'
        };
        
        function loadPresetSymbols() {
            const preset = document.getElementById('download-preset').value;
            const symbolsInput = document.getElementById('download-symbols');
            
            if (preset && presetSymbols[preset]) {
                symbolsInput.value = presetSymbols[preset];
                // å¦‚æœæ˜¯é è¨­æ¸…å–®ï¼Œå°‡ç„¦é»ç§»å›åˆ°ä¸‹è¼‰æŒ‰éˆ•
                symbolsInput.blur();
            }
        }
        
        // ==================== è¼”åŠ©å‡½æ•¸ ====================
        function showMessage(container, type, message) {
            const icon = {
                'success': 'âœ…',
                'error': 'âŒ',
                'info': 'â„¹ï¸',
                'warning': 'âš ï¸'
            }[type] || 'â„¹ï¸';
            
            container.innerHTML = `
                <div class="message message-${type}">
                    <span class="message-icon">${icon}</span>
                    <div class="message-content">${message}</div>
                </div>
            `;
        }
        
        function showLoading(container, message = 'è™•ç†ä¸­...') {
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading"></div>
                    <div class="loading-text">${message}</div>
                </div>
            `;
        }

        // æ ¼å¼åŒ–æˆäº¤é‡ï¼ˆæ–°å¢ï¼ï¼‰
        function formatVolume(volume) {
            if (!volume || volume === 0) return 'N/A';

            if (volume >= 1000000000) {
                return (volume / 1000000000).toFixed(2) + 'B';
            } else if (volume >= 1000000) {
                return (volume / 1000000).toFixed(2) + 'M';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(2) + 'K';
            } else {
                return volume.toFixed(0);
            }
        }

        // ç²å–æµå‹•æ€§è©•ç´šé¡è‰²ï¼ˆæ–°å¢ï¼ï¼‰
        function getLiquidityColor(rating) {
            const colorMap = {
                'æ¥µé«˜': 'var(--success-color)',
                'é«˜': 'var(--success-color)',
                'ä¸­ç­‰': 'var(--warning-color)',
                'ä½': 'var(--error-color)',
                'æ¥µä½': 'var(--error-color)',
                'N/A': 'var(--text-secondary)'
            };
            return colorMap[rating] || 'var(--text-secondary)';
        }

        // ==================== ç¯©é¸æ¢ä»¶è¼”åŠ©å‡½æ•¸ ====================

        // åˆ‡æ›ç¯©é¸æ¢ä»¶çš„å•Ÿç”¨/ç¦ç”¨ç‹€æ…‹
        function toggleFilter(inputId, enabled) {
            const input = document.getElementById(inputId);
            if (!input) return;

            input.disabled = !enabled;

            // å¦‚æœæ˜¯ç¯„åœè¼¸å…¥ï¼Œé‚„éœ€è¦ç¦ç”¨ç›¸é—œçš„æŒ‰éˆ•
            const buttons = document.querySelectorAll(`button[data-target="${inputId}"]`);
            buttons.forEach(btn => {
                btn.disabled = !enabled;
            });

            // å¦‚æœæœ‰å°æ‡‰çš„ max è¼¸å…¥æ¡†ï¼ˆç¯„åœè¼¸å…¥ï¼‰
            if (inputId.includes('min-')) {
                const maxId = inputId.replace('min-', 'max-');
                const maxInput = document.getElementById(maxId);
                if (maxInput) {
                    maxInput.disabled = !enabled;
                    const maxButtons = document.querySelectorAll(`button[data-target="${maxId}"]`);
                    maxButtons.forEach(btn => {
                        btn.disabled = !enabled;
                    });
                }
            }
        }

        // èª¿æ•´è¼¸å…¥æ¡†æ•¸å€¼ï¼ˆç”¨æ–¼ +/- æŒ‰éˆ•ï¼‰
        function adjustValue(inputId, delta) {
            const input = document.getElementById(inputId);
            if (!input || input.disabled) return;

            const currentValue = parseFloat(input.value) || 0;
            const min = parseFloat(input.getAttribute('min')) || -Infinity;
            const max = parseFloat(input.getAttribute('max')) || Infinity;
            const step = parseFloat(input.getAttribute('step')) || 1;

            let newValue = currentValue + delta;

            // ç¢ºä¿åœ¨ç¯„åœå…§
            newValue = Math.max(min, Math.min(max, newValue));

            // å››æ¨äº”å…¥åˆ°stepçš„å€æ•¸
            newValue = Math.round(newValue / step) * step;

            input.value = newValue;
        }

        // é‡ç½®æ‰€æœ‰ç¯©é¸æ¢ä»¶
        function resetFilters() {
            // åŸºæœ¬ç¯©é¸
            document.getElementById('screen-market').value = 'all';
            document.getElementById('screen-min-score').value = '0';
            document.getElementById('screen-max-score').value = '100';
            document.getElementById('screen-action').value = 'all';

            // åƒ¹æ ¼èˆ‡å ±é…¬
            document.getElementById('screen-min-price').value = '0';
            document.getElementById('screen-max-price').value = '9999';
            document.getElementById('screen-min-return').value = '-100';
            document.getElementById('screen-max-return').value = '100';
            document.getElementById('screen-min-target').value = '0';
            document.getElementById('screen-max-target').value = '9999';

            // é¢¨éšªèˆ‡æµå‹•æ€§
            document.getElementById('screen-min-rr').value = '0';
            document.getElementById('screen-max-rr').value = '10';
            document.getElementById('screen-min-rel-vol').value = '0';
            document.getElementById('screen-max-rel-vol').value = '10';
            document.getElementById('screen-liquidity').value = 'all';

            // æ™‚é–“èˆ‡å…¶ä»–
            document.getElementById('screen-min-days').value = '0';
            document.getElementById('screen-max-days').value = '365';
            document.getElementById('screen-min-avg-vol').value = '0';
            document.getElementById('screen-max-avg-vol').value = '999999999';

            showMessage(
                document.getElementById('screen-result'),
                'info',
                'ç¯©é¸æ¢ä»¶å·²é‡ç½®ç‚ºé è¨­å€¼'
            );
        }

        // ==================== API å‘¼å«å‡½æ•¸ ====================

        // ä¸‹è¼‰æ•¸æ“š
        async function downloadData() {
            const container = document.getElementById('download-result');
            const symbolsInput = document.getElementById('download-symbols').value.trim();
            const market = document.getElementById('download-market').value;
            const period = document.getElementById('download-period').value;
            const preset = document.getElementById('download-preset').value;
            
            if (!symbolsInput) {
                showMessage(container, 'warning', 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–é¸æ“‡é è¨­æ¸…å–®');
                return;
            }
            
            showLoading(container, 'æ­£åœ¨ä¸‹è¼‰æ•¸æ“š...');
            
            try {
                let requestBody;
                
                // åˆ¤æ–·ä¸‹è¼‰æ–¹å¼
                if (preset && preset.startsWith('us-')) {
                    // ä½¿ç”¨ç¾è‚¡é è¨­æ¸…å–®
                    const categoryMap = {
                        'us-dow': 'dow',
                        'us-sp500': 'sp500',
                        'us-nasdaq100': 'nasdaq100',
                        'us-popular': 'popular'
                    };
                    
                    requestBody = {
                        method: 'market_list',
                        market: 'US',
                        category: categoryMap[preset] || 'popular',
                        period: period
                    };
                } else if (preset && preset.startsWith('tw-')) {
                    // ä½¿ç”¨å°è‚¡é è¨­æ¸…å–®
                    const categoryMap = {
                        'tw-tw50': 'å°ç£50',
                        'tw-semiconductor': 'åŠå°é«”',
                        'tw-finance': 'é‡‘æ§',
                        'tw-all': 'all'
                    };
                    
                    requestBody = {
                        method: 'market_list',
                        market: 'TW',
                        category: categoryMap[preset] || 'popular',
                        period: period
                    };
                } else if (symbolsInput.includes(',')) {
                    // å¤šæ”¯è‚¡ç¥¨
                    requestBody = {
                        method: 'multiple',
                        symbols: symbolsInput,
                        period: period
                    };
                } else {
                    // å–®æ”¯è‚¡ç¥¨
                    requestBody = {
                        method: 'single',
                        symbol: symbolsInput,
                        period: period
                    };
                }
                
                const response = await fetch(`${API_BASE}/download`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayDownloadResult(container, data);
                } else {
                    showMessage(container, 'error', data.message);
                }
            } catch (error) {
                showMessage(container, 'error', `éŒ¯èª¤: ${error.message}`);
            }
        }
        
        // é¡¯ç¤ºä¸‹è¼‰çµæœ
        function displayDownloadResult(container, response) {
            const data = response.data;
            
            let html = `
                <div class="message message-success">
                    <span class="message-icon">âœ…</span>
                    <div class="message-content">${response.message}</div>
                </div>
            `;
            
            // å¦‚æœæœ‰è©³ç´°è³‡è¨Š
            if (data) {
                if (data.symbol) {
                    // å–®æ”¯è‚¡ç¥¨
                    html += `
                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: white; border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-primary);">ä¸‹è¼‰è©³æƒ…</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-sm);">
                                <div><strong>ä»£ç¢¼:</strong> ${data.symbol}</div>
                                <div><strong>å¸‚å ´:</strong> ${data.market}</div>
                                <div><strong>æ•¸æ“šç­†æ•¸:</strong> ${data.rows}</div>
                                <div><strong>èµ·å§‹æ—¥æœŸ:</strong> ${data.start_date}</div>
                                <div><strong>çµæŸæ—¥æœŸ:</strong> ${data.end_date}</div>
                            </div>
                        </div>
                    `;
                } else if (data.total) {
                    // æ‰¹é‡ä¸‹è¼‰
                    html += `
                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: white; border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-primary);">ä¸‹è¼‰çµ±è¨ˆ</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-sm);">
                                <div><strong>ç¸½æ•¸:</strong> ${data.total}</div>
                                <div><strong>æˆåŠŸ:</strong> <span style="color: var(--success-color);">${data.success}</span></div>
                                <div><strong>å¤±æ•—:</strong> <span style="color: var(--error-color);">${data.failed}</span></div>
                                ${data.us_stocks !== undefined ? `<div><strong>ğŸ‡ºğŸ‡¸ ç¾è‚¡:</strong> ${data.us_stocks}</div>` : ''}
                                ${data.tw_stocks !== undefined ? `<div><strong>ğŸ‡¹ğŸ‡¼ å°è‚¡:</strong> ${data.tw_stocks}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html;
        }
        
        // åˆ†æè‚¡ç¥¨
        async function analyzeStock() {
            const container = document.getElementById('analyze-result');
            const symbol = document.getElementById('analyze-symbol').value.trim().toUpperCase();
            
            if (!symbol) {
                showMessage(container, 'warning', 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
                return;
            }
            
            showLoading(container, `æ­£åœ¨åˆ†æ ${symbol}...`);
            
            try {
                const response = await fetch(`${API_BASE}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayAnalysisResult(container, data.data);
                } else {
                    showMessage(container, 'error', data.message);
                }
            } catch (error) {
                showMessage(container, 'error', `éŒ¯èª¤: ${error.message}`);
            }
        }
        
        // é¡¯ç¤ºåˆ†æçµæœ
        function displayAnalysisResult(container, data) {
            const actionBadgeClass = {
                'BUY': 'badge-buy',
                'SELL': 'badge-sell',
                'HOLD': 'badge-hold'
            };
            
            // è¨ˆç®—ç›®æ¨™åƒ¹é æœŸæ™‚é–“
            const targetTimeframe = data.target_timeframe || {};
            const timeframeText = targetTimeframe.estimated_date 
                ? `é è¨ˆ ${targetTimeframe.estimated_date} (ç´„ ${targetTimeframe.days || 'N/A'} å¤©)`
                : `ç´„ ${targetTimeframe.days || 'N/A'} å¤©`;
            
            // æ§‹å»ºæ™‚é–“ç¯„åœè©³æƒ…
            let timeframeDetails = '';
            if (targetTimeframe.best_case_days || targetTimeframe.likely_case_days || targetTimeframe.worst_case_days) {
                timeframeDetails = `
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        æ¨‚è§€: ${targetTimeframe.best_case_days || 'N/A'} å¤© | 
                        å¯èƒ½: ${targetTimeframe.likely_case_days || 'N/A'} å¤© | 
                        ä¿å®ˆ: ${targetTimeframe.worst_case_days || 'N/A'} å¤©
                    </div>
                `;
            }
            
            // æ§‹å»ºå…¬å¸åç¨±é¡¯ç¤º
            let stockNameDisplay = data.symbol;
            if (data.stock_name && data.stock_name !== data.symbol) {
                if (data.stock_name_chinese) {
                    // å°è‚¡ï¼šé¡¯ç¤ºä¸­æ–‡åç¨±
                    stockNameDisplay = `${data.symbol} ${data.stock_name_chinese}`;
                } else {
                    // ç¾è‚¡ï¼šé¡¯ç¤ºè‹±æ–‡åç¨±
                    stockNameDisplay = `${data.symbol} - ${data.stock_name}`;
                }
            }
            
            const html = `
                <div class="message message-success">
                    <span class="message-icon">âœ…</span>
                    <div class="message-content">
                        æˆåŠŸåˆ†æ ${stockNameDisplay} - ${data.rating}
                    </div>
                </div>
                
                <div class="analysis-detail">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                        <div>
                            <h3 style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">
                                ${stockNameDisplay}
                                <span class="badge badge-market" style="font-size: 1rem; margin-left: 1rem;">
                                    ${data.market_display || data.market || ''}
                                </span>
                            </h3>
                            <div style="margin-top: 0.5rem; color: var(--text-secondary);">
                                è©•ç´š: <strong style="color: var(--primary-color);">${data.rating}</strong> | 
                                æ“ä½œ: <span class="badge ${actionBadgeClass[data.action || 'HOLD']}">${data.action || 'N/A'}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 3rem; font-weight: 700; color: var(--text-primary);">
                                ${data.total_score || data.score || 0}<span style="font-size: 1.5rem; color: var(--text-secondary);">/100</span>
                            </div>
                            <div style="color: var(--text-secondary);">ç¶œåˆè©•åˆ†</div>
                        </div>
                    </div>
                    
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">ç¾åƒ¹ <small style="color: var(--text-light);">(${data.data_date || 'N/A'})</small></div>
                            <div class="metric-value" style="color: var(--primary-color);">
                                ${data.current_price ? data.current_price.toFixed(2) : 'N/A'}
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">
                                ${data.target_label || 'ç›®æ¨™åƒ¹æ ¼'}
                                <span class="info-icon" data-tooltip="åŸºæ–¼æŠ€è¡“åˆ†æè¨ˆç®—çš„ç›®æ¨™åƒ¹æ ¼">i</span>
                            </div>
                            <div class="metric-value" style="color: ${(data.expected_return || 0) >= 0 ? 'var(--success-color)' : 'var(--error-color)'};">
                                ${(data.target_price || 0).toFixed(2)}
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">é æœŸå ±é…¬ç‡</div>
                            <div class="metric-value" style="color: ${(data.expected_return || 0) >= 0 ? 'var(--success-color)' : 'var(--error-color)'};">
                                ${(data.expected_return || 0) >= 0 ? '+' : ''}${((data.expected_return || 0) * 100).toFixed(2)}%
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">
                                é¢¨éšªå ±é…¬æ¯”
                                <span class="info-icon" data-tooltip="é æœŸå ±é…¬ Ã· é¢¨éšªã€‚æ¯”å€¼ > 2 è¡¨ç¤ºé¢¨éšªå ±é…¬æ¯”ä½³ï¼Œ> 3 å„ªç§€">i</span>
                            </div>
                            <div class="metric-value" style="color: ${(data.risk_reward_ratio || 0) >= 2 ? 'var(--success-color)' : 'var(--warning-color)'};">
                                ${(data.risk_reward_ratio || 0).toFixed(2)}
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">
                                ç›®æ¨™é”æˆæ™‚é–“
                                <span class="info-icon" data-tooltip="é”åˆ°ç›®æ¨™åƒ¹æ ¼çš„é ä¼°æ™‚é–“ç¯„åœ">i</span>
                            </div>
                            <div class="metric-value" style="font-size: 1.2rem; color: var(--info-color);">
                                ${timeframeText}
                            </div>
                            ${timeframeDetails}
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">æˆåŠŸæ©Ÿç‡</div>
                            <div class="metric-value" style="color: var(--info-color);">
                                ${((data.probability || 0) * 100).toFixed(0)}%
                            </div>
                        </div>

                        <!-- æˆäº¤é‡èˆ‡æµå‹•æ€§æŒ‡æ¨™ (NEW!) -->
                        <div class="metric-card">
                            <div class="metric-label">
                                å¹³å‡æˆäº¤é‡
                                <span class="info-icon" data-tooltip="è¿‘20æ—¥å¹³å‡æˆäº¤é‡">i</span>
                            </div>
                            <div class="metric-value" style="font-size: 1.2rem; color: var(--secondary-color);">
                                ${data.avg_volume ? formatVolume(data.avg_volume) : 'N/A'}
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-label">
                                ç›¸å°æˆäº¤é‡
                                <span class="info-icon" data-tooltip="æœ€æ–°æˆäº¤é‡ Ã· å¹³å‡æˆäº¤é‡ã€‚> 1.5 è¡¨ç¤ºæ”¾é‡">i</span>
                            </div>
                            <div class="metric-value" style="color: ${(data.relative_volume || 0) > 1.5 ? 'var(--success-color)' : 'var(--text-primary)'};">
                                ${data.relative_volume ? data.relative_volume.toFixed(2) + 'x' : 'N/A'}
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-label">
                                æµå‹•æ€§è©•ç´š
                                <span class="info-icon" data-tooltip="åŸºæ–¼æˆäº¤é‡èˆ‡åƒ¹æ ¼æ³¢å‹•çš„æµå‹•æ€§è©•ä¼°">i</span>
                            </div>
                            <div class="metric-value" style="font-size: 1.2rem; color: ${getLiquidityColor(data.liquidity_rating || 'N/A')};">
                                ${data.liquidity_rating || 'N/A'}
                            </div>
                        </div>
                    </div>
                    
                    ${data.summary ? `
                        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: white; border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-primary);">ğŸ“ åˆ†ææ‘˜è¦</h4>
                            <p style="color: var(--text-secondary); line-height: 1.8;">${data.summary}</p>
                        </div>
                    ` : ''}
                    
                    ${data.key_points && data.key_points.length > 0 ? `
                        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: white; border-radius: var(--radius-md);">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-primary);">ğŸ”‘ é—œéµè¦é»</h4>
                            <ul style="margin-left: var(--spacing-lg); color: var(--text-secondary); line-height: 1.8;">
                                ${data.key_points.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${data.operation_suggestions && data.operation_suggestions.length > 0 ? `
                        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: #dbeafe; border-radius: var(--radius-md); border-left: 4px solid var(--info-color);">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-primary);">ğŸ’¡ æ“ä½œå»ºè­°</h4>
                            <ul style="margin-left: var(--spacing-lg); color: var(--text-secondary); line-height: 1.8;">
                                ${data.operation_suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${data.risks && data.risks.length > 0 ? `
                        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: #fef3c7; border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-primary);">âš ï¸ é¢¨éšªæç¤º</h4>
                            <ul style="margin-left: var(--spacing-lg); color: var(--text-secondary); line-height: 1.8;">
                                ${data.risks.map(risk => `<li>${risk}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ç¯©é¸è‚¡ç¥¨
        async function screenStocks() {
            const container = document.getElementById('screen-result');

            // è®€å–æ‰€æœ‰ç¯©é¸æ¢ä»¶ï¼ˆåªè®€å–å·²å‹¾é¸çš„ï¼‰
            const filters = {
                // åŸºæœ¬ç¯©é¸ï¼ˆå¸‚å ´æ°¸é å•Ÿç”¨ï¼‰
                market: document.getElementById('screen-market').value
            };

            // è©•åˆ†ç¯„åœ
            if (document.getElementById('enable-score')?.checked) {
                filters.min_score = parseFloat(document.getElementById('screen-min-score').value) || 0;
                filters.max_score = parseFloat(document.getElementById('screen-max-score').value) || 100;
            }

            // æ“ä½œå»ºè­°
            if (document.getElementById('enable-action')?.checked) {
                filters.action_filter = document.getElementById('screen-action').value;
            }

            // åƒ¹æ ¼ç¯„åœ
            if (document.getElementById('enable-price')?.checked) {
                filters.min_price = parseFloat(document.getElementById('screen-min-price').value) || 0;
                filters.max_price = parseFloat(document.getElementById('screen-max-price').value) || 9999;
            }

            // é æœŸå ±é…¬ç‡
            if (document.getElementById('enable-return')?.checked) {
                filters.min_expected_return = (parseFloat(document.getElementById('screen-min-return').value) || -100) / 100;
                filters.max_expected_return = (parseFloat(document.getElementById('screen-max-return').value) || 100) / 100;
            }

            // ç›®æ¨™åƒ¹ç¯„åœ
            if (document.getElementById('enable-target')?.checked) {
                filters.min_target_price = parseFloat(document.getElementById('screen-min-target').value) || 0;
                filters.max_target_price = parseFloat(document.getElementById('screen-max-target').value) || 9999;
            }

            // é¢¨éšªå ±é…¬æ¯”
            if (document.getElementById('enable-rr')?.checked) {
                filters.min_risk_reward = parseFloat(document.getElementById('screen-min-rr').value) || 0;
                filters.max_risk_reward = parseFloat(document.getElementById('screen-max-rr').value) || 10;
            }

            // ç›¸å°æˆäº¤é‡
            if (document.getElementById('enable-rel-vol')?.checked) {
                filters.min_relative_volume = parseFloat(document.getElementById('screen-min-rel-vol').value) || 0;
                filters.max_relative_volume = parseFloat(document.getElementById('screen-max-rel-vol').value) || 10;
            }

            // æµå‹•æ€§è©•ç´š
            if (document.getElementById('enable-liquidity')?.checked) {
                filters.liquidity_filter = document.getElementById('screen-liquidity').value;
            }

            // é”æˆæ™‚é–“
            if (document.getElementById('enable-days')?.checked) {
                filters.min_timeframe_days = parseFloat(document.getElementById('screen-min-days').value) || 0;
                filters.max_timeframe_days = parseFloat(document.getElementById('screen-max-days').value) || 365;
            }

            // å¹³å‡æˆäº¤é‡
            if (document.getElementById('enable-avg-vol')?.checked) {
                filters.min_avg_volume = parseFloat(document.getElementById('screen-min-avg-vol').value) || 0;
                filters.max_avg_volume = parseFloat(document.getElementById('screen-max-avg-vol').value) || 999999999;
            }

            showLoading(container, 'æ­£åœ¨ç¯©é¸è‚¡ç¥¨...');

            try {
                const response = await fetch(`${API_BASE}/screen`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });

                const data = await response.json();

                if (data.success) {
                    screenResultsData = data.data.results;
                    displayScreenResults(container, data.data);
                } else {
                    showMessage(container, 'error', data.message);
                }
            } catch (error) {
                showMessage(container, 'error', `éŒ¯èª¤: ${error.message}`);
            }
        }
        
        // é¡¯ç¤ºç¯©é¸çµæœï¼ˆå¸¶æ’åºåŠŸèƒ½ï¼‰
        function displayScreenResults(container, data) {
            const actionBadgeClass = {
                'BUY': 'badge-buy',
                'SELL': 'badge-sell',
                'HOLD': 'badge-hold'
            };
            
            let html = `
                <div style="margin-top: var(--spacing-lg);">
                    <div class="message message-success" style="margin-bottom: var(--spacing-lg);">
                        <span class="message-icon">âœ…</span>
                        <div class="message-content">
                            æ‰¾åˆ° ${data.total_matched} æ”¯ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨ï¼ˆå…±åˆ†æ ${data.total_analyzed} æ”¯ï¼‰
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th class="sortable" onclick="sortTable('market')">å¸‚å ´</th>
                                    <th class="sortable" onclick="sortTable('symbol')">ä»£ç¢¼</th>
                                    <th class="sortable" onclick="sortTable('stock_name')">åç¨±</th>
                                    <th class="sortable" onclick="sortTable('total_score')">è©•åˆ†</th>
                                    <th class="sortable" onclick="sortTable('rating')">æ“ä½œå»ºè­°</th>
                                    <th class="sortable" onclick="sortTable('current_price')">
                                        ç¾åƒ¹
                                        <span class="info-icon" data-tooltip="è³‡æ–™æ—¥æœŸè¦‹ä¸‹æ–¹æ˜ç´°">i</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('target_price')">ç›®æ¨™åƒ¹</th>
                                    <th class="sortable" onclick="sortTable('expected_return')">é æœŸå ±é…¬</th>
                                    <th class="sortable" onclick="sortTable('risk_reward_ratio')">
                                        é¢¨éšªå ±é…¬æ¯”
                                        <span class="info-icon" data-tooltip="é æœŸå ±é…¬ Ã· é¢¨éšªã€‚> 2 ä½³ï¼Œ> 3 å„ª">i</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('avg_volume')">
                                        å¹³å‡æˆäº¤é‡
                                        <span class="info-icon" data-tooltip="è¿‘20æ—¥å¹³å‡æˆäº¤é‡">i</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('relative_volume')">
                                        ç›¸å°æˆäº¤é‡
                                        <span class="info-icon" data-tooltip="æœ€æ–°æˆäº¤é‡ Ã· å¹³å‡æˆäº¤é‡ã€‚> 1.5 è¡¨ç¤ºæ”¾é‡">i</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('liquidity_rating')">
                                        æµå‹•æ€§
                                        <span class="info-icon" data-tooltip="åŸºæ–¼æˆäº¤é‡èˆ‡åƒ¹æ ¼æ³¢å‹•çš„æµå‹•æ€§è©•ä¼°">i</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('timeframe_days')">
                                        é”æˆæ™‚é–“
                                        <span class="info-icon" data-tooltip="é”åˆ°ç›®æ¨™åƒ¹çš„é ä¼°å¤©æ•¸">i</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="screen-table-body">
            `;
            
            data.results.forEach(stock => {
                const dataDate = stock.data_date || 'N/A';
                const targetTimeframe = stock.target_timeframe || {};
                const timeframeDays = targetTimeframe.days || stock.timeframe_days || 'N/A';
                const estimatedDate = targetTimeframe.estimated_date || '';
                const timeframeDisplay = estimatedDate 
                    ? `${timeframeDays}å¤©<br><small style="color: var(--text-light);">${estimatedDate}</small>`
                    : `${timeframeDays}å¤©`;
                
                // æ§‹å»ºå…¬å¸åç¨±é¡¯ç¤º
                let stockNameDisplay = '';
                if (stock.stock_name_chinese) {
                    stockNameDisplay = stock.stock_name_chinese;
                } else if (stock.stock_name && stock.stock_name !== stock.symbol) {
                    stockNameDisplay = stock.stock_name.length > 20 
                        ? stock.stock_name.substring(0, 20) + '...' 
                        : stock.stock_name;
                } else {
                    stockNameDisplay = '-';
                }
                
                html += `
                    <tr data-symbol="${stock.symbol}"
                        data-stock-name="${stockNameDisplay}"
                        data-date="${dataDate}"
                        data-score="${stock.total_score || stock.score || 0}"
                        data-price="${stock.current_price || 0}"
                        data-target="${stock.target_price || 0}"
                        data-return="${stock.expected_return || 0}"
                        data-rr="${stock.risk_reward_ratio || 0}"
                        data-avg-volume="${stock.avg_volume || 0}"
                        data-relative-volume="${stock.relative_volume || 0}"
                        data-liquidity="${stock.liquidity_rating || 'N/A'}"
                        data-timeframe="${timeframeDays}">
                        <td><span class="badge badge-market">${stock.market_display || stock.market || ''}</span></td>
                        <td><strong>${stock.symbol || ''}</strong></td>
                        <td style="font-size: 0.9rem;">${stockNameDisplay}</td>
                        <td><strong style="color: var(--primary-color);">${(stock.total_score || stock.score || 0).toFixed(1)}</strong></td>
                        <td><span class="badge ${actionBadgeClass[stock.action || 'HOLD']}">${stock.action || 'N/A'}</span></td>
                        <td>
                            ${stock.current_price ? stock.current_price.toFixed(2) : 'N/A'}
                            <br><small style="color: var(--text-light);">${dataDate}</small>
                        </td>
                        <td>${stock.target_price ? stock.target_price.toFixed(2) : 'N/A'}</td>
                        <td style="color: ${(stock.expected_return || 0) >= 0 ? 'var(--success-color)' : 'var(--error-color)'}; font-weight: 600;">
                            ${(stock.expected_return || 0) >= 0 ? '+' : ''}${((stock.expected_return || 0) * 100).toFixed(2)}%
                        </td>
                        <td style="color: ${(stock.risk_reward_ratio || 0) >= 2 ? 'var(--success-color)' : 'var(--warning-color)'}; font-weight: 600;">
                            ${(stock.risk_reward_ratio || 0).toFixed(2)}
                        </td>
                        <td style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${stock.avg_volume ? formatVolume(stock.avg_volume) : 'N/A'}
                        </td>
                        <td style="color: ${(stock.relative_volume || 0) > 1.5 ? 'var(--success-color)' : 'var(--text-secondary)'}; font-weight: ${(stock.relative_volume || 0) > 1.5 ? '600' : '400'};">
                            ${stock.relative_volume ? stock.relative_volume.toFixed(2) + 'x' : 'N/A'}
                        </td>
                        <td style="color: ${getLiquidityColor(stock.liquidity_rating || 'N/A')}; font-weight: 600; font-size: 0.9rem;">
                            ${stock.liquidity_rating || 'N/A'}
                        </td>
                        <td style="color: var(--info-color);">
                            ${timeframeDisplay}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // è¡¨æ ¼æ’åºåŠŸèƒ½
        function sortTable(column) {
            const table = document.querySelector('#screen-table-body');
            if (!table) return;
            
            const rows = Array.from(table.querySelectorAll('tr'));
            
            // ç¢ºå®šæ’åºæ–¹å‘
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // æ›´æ–°è¡¨é ­æ’åºæŒ‡ç¤ºå™¨
            document.querySelectorAll('.table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const headerCells = document.querySelectorAll('.table th');
            const columnIndex = {
                'market': 0,
                'symbol': 1,
                'stock_name': 2,
                'total_score': 3,
                'rating': 4,
                'current_price': 5,
                'target_price': 6,
                'expected_return': 7,
                'risk_reward_ratio': 8,
                'avg_volume': 9,
                'relative_volume': 10,
                'liquidity_rating': 11,
                'timeframe_days': 12
            };
            
            if (columnIndex[column] !== undefined) {
                headerCells[columnIndex[column]].classList.add(
                    currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc'
                );
            }
            
            // æ’åºè¡Œ
            rows.sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 'symbol':
                        aVal = a.dataset.symbol || '';
                        bVal = b.dataset.symbol || '';
                        break;
                    case 'stock_name':
                        aVal = a.dataset.stockName || '';
                        bVal = b.dataset.stockName || '';
                        break;
                    case 'market':
                        aVal = a.querySelector('.badge-market')?.textContent || '';
                        bVal = b.querySelector('.badge-market')?.textContent || '';
                        break;
                    case 'total_score':
                        aVal = parseFloat(a.dataset.score) || 0;
                        bVal = parseFloat(b.dataset.score) || 0;
                        break;
                    case 'current_price':
                        aVal = parseFloat(a.dataset.price) || 0;
                        bVal = parseFloat(b.dataset.price) || 0;
                        break;
                    case 'target_price':
                        aVal = parseFloat(a.dataset.target) || 0;
                        bVal = parseFloat(b.dataset.target) || 0;
                        break;
                    case 'expected_return':
                        aVal = parseFloat(a.dataset.return) || 0;
                        bVal = parseFloat(b.dataset.return) || 0;
                        break;
                    case 'risk_reward_ratio':
                        aVal = parseFloat(a.dataset.rr) || 0;
                        bVal = parseFloat(b.dataset.rr) || 0;
                        break;
                    case 'avg_volume':
                        aVal = parseFloat(a.dataset.avgVolume) || 0;
                        bVal = parseFloat(b.dataset.avgVolume) || 0;
                        break;
                    case 'relative_volume':
                        aVal = parseFloat(a.dataset.relativeVolume) || 0;
                        bVal = parseFloat(b.dataset.relativeVolume) || 0;
                        break;
                    case 'liquidity_rating':
                        const liquidityOrder = {'æ¥µé«˜': 5, 'é«˜': 4, 'ä¸­ç­‰': 3, 'ä½': 2, 'æ¥µä½': 1, 'N/A': 0};
                        aVal = liquidityOrder[a.dataset.liquidity] || 0;
                        bVal = liquidityOrder[b.dataset.liquidity] || 0;
                        break;
                    case 'timeframe_days':
                        aVal = parseFloat(a.dataset.timeframe) || 999999;
                        bVal = parseFloat(b.dataset.timeframe) || 999999;
                        break;
                    case 'rating':
                        const ratingOrder = {'å¼·åŠ›è²·å…¥': 4, 'è²·å…¥': 3, 'æŒæœ‰': 2, 'è§€æœ›': 1, 'è€ƒæ…®æ¸›å€‰': 0};
                        const aRating = a.querySelector('.badge')?.textContent || '';
                        const bRating = b.querySelector('.badge')?.textContent || '';
                        aVal = ratingOrder[aRating] || 0;
                        bVal = ratingOrder[bRating] || 0;
                        break;
                    default:
                        return 0;
                }
                
                if (typeof aVal === 'string') {
                    return currentSortDirection === 'asc' 
                        ? aVal.localeCompare(bVal) 
                        : bVal.localeCompare(aVal);
                } else {
                    return currentSortDirection === 'asc' 
                        ? aVal - bVal 
                        : bVal - aVal;
                }
            });
            
            // é‡æ–°æ’å…¥æ’åºå¾Œçš„è¡Œ
            rows.forEach(row => table.appendChild(row));
        }
        
        // è¼‰å…¥æœ¬åœ°è‚¡ç¥¨
        async function loadLocalStocks() {
            const container = document.getElementById('local-result');
            showLoading(container, 'è¼‰å…¥æœ¬åœ°è‚¡ç¥¨...');
            
            try {
                const response = await fetch(`${API_BASE}/local-stocks`);
                const data = await response.json();
                
                if (data.success) {
                    displayLocalStocks(container, data.data);
                } else {
                    showMessage(container, 'error', data.message);
                }
            } catch (error) {
                showMessage(container, 'error', `éŒ¯èª¤: ${error.message}`);
            }
        }
        
        // é¡¯ç¤ºæœ¬åœ°è‚¡ç¥¨
        function displayLocalStocks(container, data) {
            if (!data.stocks || data.stocks.length === 0) {
                showMessage(container, 'info', 'å°šç„¡æœ¬åœ°è‚¡ç¥¨æ•¸æ“šï¼Œè«‹å…ˆä¸‹è¼‰');
                return;
            }
            
            let html = `
                <div style="margin-top: var(--spacing-lg);">
                    <!-- çµ±è¨ˆæ‘˜è¦ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: var(--spacing-md); border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow-md);">
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: var(--spacing-xs);">
                                ${data.us_count}
                            </div>
                            <div style="opacity: 0.9;">ğŸ‡ºğŸ‡¸ ç¾è‚¡</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: var(--spacing-md); border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow-md);">
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: var(--spacing-xs);">
                                ${data.tw_count}
                            </div>
                            <div style="opacity: 0.9;">ğŸ‡¹ğŸ‡¼ å°è‚¡</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: var(--spacing-md); border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow-md);">
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: var(--spacing-xs);">
                                ${data.total}
                            </div>
                            <div style="opacity: 0.9;">ç¸½è¨ˆ</div>
                        </div>
                    </div>
                    
                    <!-- è‚¡ç¥¨åˆ—è¡¨ -->
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>å¸‚å ´</th>
                                    <th>ä»£ç¢¼</th>
                                    <th>æ•¸æ“šç­†æ•¸</th>
                                    <th>é–‹å§‹æ—¥æœŸ</th>
                                    <th>çµæŸæ—¥æœŸ</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.stocks.forEach(stock => {
                html += `
                    <tr>
                        <td><span class="badge badge-market">${stock.market_display || stock.market || ''}</span></td>
                        <td><strong>${stock.symbol}</strong></td>
                        <td>${stock.rows || 'N/A'}</td>
                        <td>${stock.start_date || 'N/A'}</td>
                        <td>${stock.end_date || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ==================== é é¢è¼‰å…¥æ™‚åŸ·è¡Œ ====================
        window.addEventListener('DOMContentLoaded', () => {
            console.log('å¤šå¸‚å ´æ™ºèƒ½é¸è‚¡ç³»çµ± v4.0 å·²è¼‰å…¥');

            // è‡ªå‹•ç‚ºæ‰€æœ‰ç¯©é¸æ¢ä»¶æ·»åŠ checkboxï¼ˆå¦‚æœé‚„æ²’æœ‰çš„è©±ï¼‰
            autoAddCheckboxes();
        });

        // è‡ªå‹•ç‚ºç¯©é¸æ¢ä»¶æ·»åŠ checkbox
        function autoAddCheckboxes() {
            // å®šç¾©éœ€è¦æ·»åŠ checkboxçš„æ¢ä»¶IDåˆ—è¡¨
            const filterIds = [
                { inputId: 'screen-min-price', label: 'ç¾åƒ¹ç¯„åœ', enableId: 'enable-price' },
                { inputId: 'screen-min-return', label: 'é æœŸå ±é…¬ç‡ (%)', enableId: 'enable-return' },
                { inputId: 'screen-min-target', label: 'ç›®æ¨™åƒ¹ç¯„åœ', enableId: 'enable-target' },
                { inputId: 'screen-min-rr', label: 'é¢¨éšªå ±é…¬æ¯”', enableId: 'enable-rr' },
                { inputId: 'screen-min-rel-vol', label: 'ç›¸å°æˆäº¤é‡', enableId: 'enable-rel-vol' },
                { inputId: 'screen-liquidity', label: 'æµå‹•æ€§è©•ç´š', enableId: 'enable-liquidity' },
                { inputId: 'screen-min-days', label: 'é”æˆæ™‚é–“ (å¤©)', enableId: 'enable-days' },
                { inputId: 'screen-min-avg-vol', label: 'å¹³å‡æˆäº¤é‡', enableId: 'enable-avg-vol' }
            ];

            filterIds.forEach(filter => {
                const input = document.getElementById(filter.inputId);
                if (!input) return;

                // æª¢æŸ¥æ˜¯å¦å·²æœ‰checkbox
                const existingCheckbox = document.getElementById(filter.enableId);
                if (existingCheckbox) return;

                // æ‰¾åˆ°çˆ¶ç´šçš„ filter-item
                let filterItem = input.closest('.filter-item');
                if (!filterItem) return;

                // æ‰¾åˆ°åŸå§‹label
                let label = filterItem.querySelector('.filter-label');
                if (!label) return;

                // å¦‚æœlabelå·²ç¶“åŒ…å«checkboxçµæ§‹ï¼Œè·³é
                if (label.querySelector('.filter-checkbox')) return;

                // ä¿å­˜åŸå§‹labelæ–‡æœ¬
                const labelText = label.textContent.trim();

                // å‰µå»ºæ–°çš„labelçµæ§‹
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'filter-checkbox';
                checkbox.id = filter.enableId;
                checkbox.onchange = function() {
                    toggleFilter(filter.inputId, this.checked);
                };

                const labelSpan = document.createElement('span');
                labelSpan.className = 'filter-label-text';
                labelSpan.textContent = labelText;

                // æ¸…ç©ºä¸¦é‡å»ºlabel
                label.innerHTML = '';
                label.appendChild(checkbox);
                label.appendChild(labelSpan);

                // åˆå§‹åŒ–ç‚ºç¦ç”¨ç‹€æ…‹
                toggleFilter(filter.inputId, false);
            });
        }
    </script>
</body>
</html>
